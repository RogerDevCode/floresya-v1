<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FloresYa - Monitoring Dashboard</title>
    <link href="/css/tailwind.css" rel="stylesheet" />
    <script src="/js/chart.min.js"></script>
    <style>
      .metric-card {
        transition: all 0.3s ease;
      }
      .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .status-healthy {
        background-color: #10b981;
      }
      .status-warning {
        background-color: #f59e0b;
      }
      .status-critical {
        background-color: #ef4444;
      }
      .status-degraded {
        background-color: #f97316;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">FloresYa Monitoring Dashboard</h1>
        <p class="text-gray-600">Real-time system monitoring and performance metrics</p>
        <div class="mt-4 flex items-center space-x-4">
          <div id="lastUpdate" class="text-sm text-gray-500">Last updated: Never</div>
          <button
            id="refreshBtn"
            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"
          >
            Refresh
          </button>
          <button
            id="autoRefreshToggle"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm"
          >
            Auto Refresh: ON
          </button>
        </div>
      </header>

      <!-- System Health Overview -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="metric-card bg-white p-6 rounded-lg shadow">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">System Health</h3>
              <p id="healthScore" class="text-2xl font-bold text-gray-700">--</p>
            </div>
            <div id="healthStatus" class="w-4 h-4 rounded-full"></div>
          </div>
          <p class="text-sm text-gray-500 mt-2">Overall system status</p>
        </div>

        <div class="metric-card bg-white p-6 rounded-lg shadow">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">Response Time</h3>
              <p id="avgResponseTime" class="text-2xl font-bold text-gray-700">--ms</p>
            </div>
            <div class="text-green-500">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd"
                ></path>
              </svg>
            </div>
          </div>
          <p class="text-sm text-gray-500 mt-2">Average response time</p>
        </div>

        <div class="metric-card bg-white p-6 rounded-lg shadow">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">CPU Usage</h3>
              <p id="cpuUsage" class="text-2xl font-bold text-gray-700">--%</p>
            </div>
            <div class="text-blue-500">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
                ></path>
              </svg>
            </div>
          </div>
          <p class="text-sm text-gray-500 mt-2">Current CPU utilization</p>
        </div>

        <div class="metric-card bg-white p-6 rounded-lg shadow">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">Memory Usage</h3>
              <p id="memoryUsage" class="text-2xl font-bold text-gray-700">--MB</p>
            </div>
            <div class="text-purple-500">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"
                  clip-rule="evenodd"
                ></path>
              </svg>
            </div>
          </div>
          <p class="text-sm text-gray-500 mt-2">Heap memory usage</p>
        </div>
      </div>

      <!-- Performance Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Response Time Chart -->
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">Response Time Trends</h3>
          <canvas id="responseTimeChart" width="400" height="200"></canvas>
        </div>

        <!-- Throughput Chart -->
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">Request Throughput</h3>
          <canvas id="throughputChart" width="400" height="200"></canvas>
        </div>
      </div>

      <!-- Detailed Metrics -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Database Metrics -->
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">Database Performance</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">Total Queries</span>
              <span id="totalQueries" class="font-semibold">--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Avg Query Time</span>
              <span id="avgQueryTime" class="font-semibold">--ms</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Slow Queries</span>
              <span id="slowQueries" class="font-semibold text-red-600">--</span>
            </div>
          </div>
        </div>

        <!-- Error Metrics -->
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">Error Statistics</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">Total Errors</span>
              <span id="totalErrors" class="font-semibold">--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Error Rate</span>
              <span id="errorRate" class="font-semibold">--%</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Recent Errors</span>
              <span id="recentErrors" class="font-semibold">--</span>
            </div>
          </div>
        </div>

        <!-- Business Metrics -->
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">Business Metrics</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">Orders</span>
              <span id="totalOrders" class="font-semibold">--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Products</span>
              <span id="totalProducts" class="font-semibold">--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Users</span>
              <span id="totalUsers" class="font-semibold">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Performance Benchmarking Controls -->
      <div class="bg-white p-6 rounded-lg shadow mb-8">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Performance Benchmarking</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <div>
            <button
              id="runBenchmarkBtn"
              class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg"
            >
              Run Benchmarks
            </button>
          </div>
          <div>
            <button
              id="runQuickBenchmarkBtn"
              class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg"
            >
              Quick Benchmark
            </button>
          </div>
          <div>
            <button
              id="viewBenchmarkReportsBtn"
              class="w-full bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg"
            >
              View Reports
            </button>
          </div>
          <div>
            <button
              id="checkRegressionsBtn"
              class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg"
            >
              Check Regressions
            </button>
          </div>
        </div>
        <div id="benchmarkStatus" class="text-sm text-gray-600">Benchmark status: Ready</div>
        <div id="benchmarkResults" class="mt-4 hidden">
          <h4 class="font-semibold text-gray-900 mb-2">Latest Benchmark Results</h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
              <span class="text-gray-600">API Performance:</span>
              <span id="benchmarkApiScore" class="font-semibold text-green-600">--</span>
            </div>
            <div>
              <span class="text-gray-600">Database:</span>
              <span id="benchmarkDbScore" class="font-semibold text-blue-600">--</span>
            </div>
            <div>
              <span class="text-gray-600">Cache:</span>
              <span id="benchmarkCacheScore" class="font-semibold text-purple-600">--</span>
            </div>
            <div>
              <span class="text-gray-600">Regressions:</span>
              <span id="benchmarkRegressions" class="font-semibold text-red-600">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Profiling Controls -->
      <div class="bg-white p-6 rounded-lg shadow mb-8">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Profiling Controls</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <button
              id="startProfilingBtn"
              class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
            >
              Start Profiling
            </button>
          </div>
          <div>
            <button
              id="stopProfilingBtn"
              class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg"
            >
              Stop Profiling
            </button>
          </div>
          <div>
            <button
              id="generateReportBtn"
              class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg"
            >
              Generate Report
            </button>
          </div>
        </div>
        <div id="profilingStatus" class="mt-4 text-sm text-gray-600">
          Profiling status: Checking...
        </div>
      </div>

      <!-- Alerts Section -->
      <div id="alertsSection" class="bg-white p-6 rounded-lg shadow" style="display: none">
        <h3 class="text-xl font-semibold text-red-600 mb-4">⚠️ Active Alerts</h3>
        <div id="alertsList" class="space-y-2"></div>
      </div>
    </div>

    <script>
      // Global state
      let autoRefreshInterval = null;
      let isAutoRefreshEnabled = true;
      let responseTimeData = [];
      let throughputData = [];
      const maxDataPoints = 20;

      // Initialize charts
      const responseTimeChart = new Chart(document.getElementById('responseTimeChart'), {
          type: 'line',
          data: {
              labels: [],
              datasets: [{
                  label: 'Response Time (ms)',
                  data: [],
                  borderColor: 'rgb(59, 130, 246)',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  tension: 0.4
              }]
          },
          options: {
              responsive: true,
              scales: {
                  y: { beginAtZero: true }
              }
          }
      });

      const throughputChart = new Chart(document.getElementById('throughputChart'), {
          type: 'line',
          data: {
              labels: [],
              datasets: [{
                  label: 'Requests/sec',
                  data: [],
                  borderColor: 'rgb(16, 185, 129)',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  tension: 0.4
              }]
          ],
          options: {
              responsive: true,
              scales: {
                  y: { beginAtZero: true }
              }
          }
      });

      // Update dashboard with metrics
      async function updateDashboard() {
          try {
              const response = await fetch('/health/metrics');
              const data = await response.json();

              if (data.success) {
                  updateMetrics(data.data);
                  updateCharts(data.data);
                  checkAlerts(data.data);
              }

              document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
          } catch (error) {
              console.error('Failed to update dashboard:', error);
          }
      }

      function updateMetrics(metrics) {
          // System health
          document.getElementById('healthScore').textContent = `${metrics.performance.totalRequests > 0 ?
              Math.round((metrics.performance.successfulRequests / metrics.performance.totalRequests) * 100) : 0}%`;
          document.getElementById('avgResponseTime').textContent = `${Math.round(metrics.performance.averageResponseTime)}ms`;
          document.getElementById('cpuUsage').textContent = `${Math.round(metrics.cpu.usage)}%`;
          document.getElementById('memoryUsage').textContent = `${Math.round(metrics.memoryUsage.heapUsed)}MB`;

          // Update health status indicator
          const healthStatus = document.getElementById('healthStatus');
          const healthScore = metricsCollector?.calculateHealthScore ? metricsCollector.calculateHealthScore() : 100;
          healthStatus.className = 'w-4 h-4 rounded-full';
          if (healthScore >= 80) healthStatus.classList.add('status-healthy');
          else if (healthScore >= 60) healthStatus.classList.add('status-warning');
          else healthStatus.classList.add('status-critical');

          // Database metrics
          document.getElementById('totalQueries').textContent = metrics.database.queryCount;
          document.getElementById('avgQueryTime').textContent = `${Math.round(metrics.database.averageQueryTime)}ms`;
          document.getElementById('slowQueries').textContent = metrics.database.slowQueriesCount;

          // Error metrics
          document.getElementById('totalErrors').textContent = metrics.errors.total;
          document.getElementById('errorRate').textContent = `${metrics.performance.errorRate}%`;
          document.getElementById('recentErrors').textContent = metrics.errors.recent.length;

          // Business metrics
          document.getElementById('totalOrders').textContent = metrics.business.orders;
          document.getElementById('totalProducts').textContent = metrics.business.products;
          document.getElementById('totalUsers').textContent = metrics.business.users;
      }

      function updateCharts(metrics) {
          const timestamp = new Date().toLocaleTimeString();

          // Update response time chart
          responseTimeData.push(metrics.performance.averageResponseTime);
          if (responseTimeData.length > maxDataPoints) responseTimeData.shift();

          responseTimeChart.data.labels.push(timestamp);
          responseTimeChart.data.datasets[0].data = [...responseTimeData];
          if (responseTimeChart.data.labels.length > maxDataPoints) {
              responseTimeChart.data.labels.shift();
          }
          responseTimeChart.update();

          // Update throughput chart
          throughputData.push(metrics.performance.throughput.perSecond);
          if (throughputData.length > maxDataPoints) throughputData.shift();

          throughputChart.data.labels.push(timestamp);
          throughputChart.data.datasets[0].data = [...throughputData];
          if (throughputChart.data.labels.length > maxDataPoints) {
              throughputChart.data.labels.shift();
          }
          throughputChart.update();
      }

      function checkAlerts(metrics) {
          const alerts = [];

          if (metrics.cpu.monitoringOverhead > 50) {
              alerts.push({
                  level: 'critical',
                  message: `Monitoring overhead too high: ${metrics.cpu.monitoringOverhead}% (limit: 50%)`
              });
          }

          if (metrics.memoryUsage.heapUsed > 500) {
              alerts.push({
                  level: 'warning',
                  message: `High memory usage: ${metrics.memoryUsage.heapUsed}MB`
              });
          }

          if (metrics.performance.errorRate > 10) {
              alerts.push({
                  level: 'error',
                  message: `High error rate: ${metrics.performance.errorRate}%`
              });
          }

          const alertsSection = document.getElementById('alertsSection');
          const alertsList = document.getElementById('alertsList');

          if (alerts.length > 0) {
              alertsList.innerHTML = alerts.map(alert =>
                  `<div class="p-3 rounded-lg ${alert.level === 'critical' ? 'bg-red-100 text-red-800' :
                      alert.level === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-orange-100 text-orange-800'}">
                      ${alert.message}
                  </div>`
              ).join('');
              alertsSection.style.display = 'block';
          } else {
              alertsSection.style.display = 'none';
          }
      }

      // Benchmarking controls
      async function updateBenchmarkStatus() {
        try {
          // Check if benchmark results exist
          const response = await fetch('/health/benchmark/status');
          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              document.getElementById('benchmarkStatus').textContent = `Benchmark status: ${data.data.status}`;
              if (data.data.lastRun) {
                document.getElementById('benchmarkResults').classList.remove('hidden');
                document.getElementById('benchmarkApiScore').textContent =
                  `${data.data.lastRun.benchmarks?.api?.averageResponseTime?.toFixed(1) || '--'}ms`;
                document.getElementById('benchmarkDbScore').textContent =
                  `${data.data.lastRun.benchmarks?.database?.averageResponseTime?.toFixed(1) || '--'}ms`;
                document.getElementById('benchmarkCacheScore').textContent =
                  `${data.data.lastRun.benchmarks?.cache?.averageResponseTime?.toFixed(1) || '--'}ms`;
                document.getElementById('benchmarkRegressions').textContent =
                  data.data.lastRun.regressions?.length || 0;
              }
            }
          }
        } catch (error) {
          document.getElementById('benchmarkStatus').textContent = 'Benchmark status: Service unavailable';
        }
      }

      // Profiling controls
      async function updateProfilingStatus() {
          try {
              const response = await fetch('/health/profiling');
              const data = await response.json();

              if (data.success) {
                  const status = data.data;
                  document.getElementById('profilingStatus').textContent =
                      `Profiling status: ${status.isActive ? 'Active' : 'Inactive'} | ` +
                      `Can start: ${status.canStart ? 'Yes' : 'No'} | ` +
                      `Overhead: ${status.currentCpuOverhead}%`;
              }
          } catch (error) {
              document.getElementById('profilingStatus').textContent = 'Profiling status: Error checking status';
          }
      }

      // Event listeners
      document.getElementById('refreshBtn').addEventListener('click', updateDashboard);
      document.getElementById('autoRefreshToggle').addEventListener('click', () => {
          isAutoRefreshEnabled = !isAutoRefreshEnabled;
          const btn = document.getElementById('autoRefreshToggle');
          btn.textContent = `Auto Refresh: ${isAutoRefreshEnabled ? 'ON' : 'OFF'}`;
          btn.className = isAutoRefreshEnabled ?
              'bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm' :
              'bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm';

          if (isAutoRefreshEnabled) {
              autoRefreshInterval = setInterval(updateDashboard, 5000);
          } else {
              clearInterval(autoRefreshInterval);
          }
      });

      document.getElementById('startProfilingBtn').addEventListener('click', async () => {
          try {
              const response = await fetch('/health/profiling/start', { method: 'POST' });
              const data = await response.json();
              alert(data.message);
              updateProfilingStatus();
          } catch (error) {
              alert('Failed to start profiling');
          }
      });

      document.getElementById('stopProfilingBtn').addEventListener('click', async () => {
          try {
              const response = await fetch('/health/profiling/stop', { method: 'POST' });
              const data = await response.json();
              alert(data.message);
              updateProfilingStatus();
          } catch (error) {
              alert('Failed to stop profiling');
          }
      });

      document.getElementById('generateReportBtn').addEventListener('click', async () => {
          try {
              const response = await fetch('/health/metrics/report');
              const data = await response.json();
              console.log('Performance Report:', data);

              // Create downloadable JSON file
              const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `performance-report-${new Date().toISOString().split('T')[0]}.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              alert('Performance report downloaded!');
          } catch (error) {
              alert('Failed to generate report');
          }
      });

      // Benchmark event listeners
      document.getElementById('runBenchmarkBtn').addEventListener('click', async () => {
        alert('Benchmark feature is currently disabled.');
      });

      document.getElementById('runQuickBenchmarkBtn').addEventListener('click', async () => {
        alert('Benchmark feature is currently disabled.');
      });

      document.getElementById('viewBenchmarkReportsBtn').addEventListener('click', () => {
        alert('Benchmark reports are currently disabled.');
      });

      document.getElementById('checkRegressionsBtn').addEventListener('click', async () => {
        alert('Regression check is currently disabled.');
      });

      // Initialize
      updateDashboard();
      updateProfilingStatus();
      // updateBenchmarkStatus();

      // Start auto-refresh
      autoRefreshInterval = setInterval(updateDashboard, 5000);
      setInterval(updateProfilingStatus, 10000); // Update profiling status every 10 seconds
      // setInterval(updateBenchmarkStatus, 30000); // Update benchmark status every 30 seconds
    </script>
  </body>
</html>
