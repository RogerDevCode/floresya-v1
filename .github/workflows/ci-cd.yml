name: FloresYa CI/CD Pipeline - Optimized

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20.x'
  COVERAGE_THRESHOLD: 80

jobs:
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint
      continue-on-error: false

    - name: Check Prettier formatting
      run: npm run format:check
      continue-on-error: true

    - name: Validate API client sync
      run: npm run validate:client:sync
      continue-on-error: true

  test-coverage:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: lint-and-format

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run all tests with coverage
      run: npm run test:coverage
      env:
        NODE_ENV: test
      continue-on-error: false

    - name: Check coverage thresholds
      run: |
        if [ -f coverage/coverage-summary.json ]; then
          echo "‚úÖ Coverage summary found"
          
          LINES=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
          FUNCTIONS=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
          BRANCHES=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
          STATEMENTS=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)

          echo "Coverage Report:"
          echo "Lines: $LINES%"
          echo "Functions: $FUNCTIONS%"
          echo "Branches: $BRANCHES%"
          echo "Statements: $STATEMENTS%"

          # Warning if below threshold (but don't fail) - using awk instead of bc
          THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
          if [ $(echo "$LINES < $THRESHOLD" | awk '{print ($1 < $3)}') -eq 1 ]; then
            echo "‚ö†Ô∏è Lines coverage below ${THRESHOLD}%: $LINES%"
          fi
          if [ $(echo "$FUNCTIONS < $THRESHOLD" | awk '{print ($1 < $3)}') -eq 1 ]; then
            echo "‚ö†Ô∏è Functions coverage below ${THRESHOLD}%: $FUNCTIONS%"
          fi
          if [ $(echo "$BRANCHES < $THRESHOLD" | awk '{print ($1 < $3)}') -eq 1 ]; then
            echo "‚ö†Ô∏è Branches coverage below ${THRESHOLD}%: $BRANCHES%"
          fi
          if [ $(echo "$STATEMENTS < $THRESHOLD" | awk '{print ($1 < $3)}') -eq 1 ]; then
            echo "‚ö†Ô∏è Statements coverage below ${THRESHOLD}%: $STATEMENTS%"
          fi

          echo "‚úÖ Coverage check completed"
        else
          echo "‚ö†Ô∏è No coverage summary found"
        fi
      continue-on-error: true

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      if: always() && secrets.CODECOV_TOKEN != ''
      continue-on-error: true
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-${{ github.run_number }}
        path: coverage/
        retention-days: 7
        if-no-files-found: ignore

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: lint-and-format

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      run: |
        npm audit --audit-level=moderate --json > npm-audit-results.json || true
        if [ -f npm-audit-results.json ]; then
          VULNERABILITIES=$(jq -r '.metadata.vulnerabilities.total // 0' npm-audit-results.json)
          echo "Found $VULNERABILITIES vulnerabilities"
          
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "‚ö†Ô∏è Vulnerabilities found:"
            jq '.metadata.vulnerabilities' npm-audit-results.json
          fi
          
          # Only fail if critical/high vulnerabilities
          CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)
          HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-results.json)
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 5 ]; then
            echo "‚ùå Critical or too many high vulnerabilities found"
            exit 1
          fi
        fi

    - name: Run Snyk scan
      uses: snyk/actions/node@master
      if: secrets.SNYK_TOKEN != ''
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results-${{ github.run_number }}
        path: npm-audit-results.json
        retention-days: 7
        if-no-files-found: ignore

  build-and-validate:
    name: Build & Validate
    runs-on: ubuntu-latest
    needs: [lint-and-format, test-coverage]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build CSS
      run: npm run build:css

    - name: Validate build artifacts
      run: |
        echo "üîç Validating build artifacts..."
        if [ ! -f "public/css/tailwind.css" ]; then
          echo "‚ùå CSS build failed - tailwind.css not found"
          exit 1
        fi
        echo "‚úÖ Build artifacts validated"

    - name: Run contract validation
      run: npm run validate:full
      continue-on-error: true

    - name: Check deployment readiness
      run: |
        echo "üöÄ Checking deployment readiness..."
        
        # Check package.json integrity
        npm ls --depth=0 > /dev/null 2>&1 || echo "‚ö†Ô∏è Package dependency warnings"

        # Check for critical files
        CRITICAL_FILES=("package.json" "api/server.js" "api/app.js" "public/index.html")
        for file in "${CRITICAL_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Critical file missing: $file"
            exit 1
          fi
        done

        echo "‚úÖ Deployment readiness checks passed"

    - name: Create deployment artifact
      run: |
        echo "üì¶ Creating deployment artifact..."
        mkdir -p dist
        cp -r api/ dist/
        cp -r public/ dist/
        cp package.json dist/
        cp package-lock.json dist/
        echo "‚úÖ Deployment artifact created"

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifact-${{ github.run_number }}
        path: dist/
        retention-days: 7

  e2e-tests:
    name: E2E Tests (Cypress)
    runs-on: ubuntu-latest
    needs: [build-and-validate]
    timeout-minutes: 20
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build CSS
      run: npm run build:css

    - name: Create .env.local file
      run: |
        echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env.local
        echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> .env.local
        echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env.local
        echo "NODE_ENV=test" >> .env.local
        echo "PORT=3001" >> .env.local
        echo "BASE_URL=http://localhost:3001" >> .env.local

    - name: Seed test data
      run: npm run seed:test
      env:
        NODE_ENV: test
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      continue-on-error: true

    - name: Start Docker services
      run: |
        echo "üê≥ Starting Docker services..."
        docker compose up -d app
        
        echo "Waiting for app service..."
        timeout 120 bash -c 'until docker compose exec -T app curl -f http://localhost:3001/health 2>/dev/null; do sleep 5; done' || {
          echo "‚ùå App service failed to start"
          docker compose logs app
          exit 1
        }
        echo "‚úÖ App service is ready!"

    - name: Run Cypress E2E tests
      run: docker compose run --rm cypress npx cypress run --config-file /cypress.config.js
      env:
        CI: true
        NODE_ENV: test
      continue-on-error: true

    - name: Upload Cypress videos
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cypress-videos-${{ github.run_number }}
        path: cypress/videos/
        retention-days: 7
        if-no-files-found: ignore

    - name: Stop Docker services
      if: always()
      run: docker compose down

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: [build-and-validate]
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Vercel Preview
      run: |
        echo "üìù Preview deployment would go here"
        echo "PR: ${{ github.event.pull_request.number }}"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-validate, e2e-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build CSS
      run: npm run build:css

    - name: Deploy to Production
      run: |
        echo "üöÄ Production deployment would go here"
        echo "Branch: ${{ github.ref }}"

    - name: Create deployment tag
      run: |
        TAG_NAME="deploy-$(date +%Y%m%d-%H%M%S)"
        echo "Created tag: $TAG_NAME"
