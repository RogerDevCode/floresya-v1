name: FloresYa CI/CD Pipeline - Fixed

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20.x'
  COVERAGE_THRESHOLD: 30

jobs:
  diagnose-environment:
    name: Diagnose CI Environment
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run environment diagnostics
      run: node scripts/diagnose-ci-environment.js
      env:
        CI: true
        NODE_ENV: test

  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    needs: diagnose-environment

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint
      continue-on-error: false

    - name: Check Prettier formatting
      run: npm run format:check
      continue-on-error: true

    - name: Validate API client sync
      run: npm run validate:client:sync
      continue-on-error: true

    - name: Validate API Contract
      run: npm run validate:contract:ci
      continue-on-error: false

  test-coverage:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: lint-and-format

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run all tests with coverage
      run: npm run test:coverage
      env:
        NODE_ENV: test
      continue-on-error: false

    - name: Check coverage thresholds
      run: |
        if [ -f coverage/coverage-summary.json ]; then
          echo "‚úÖ Coverage summary found"
          
          LINES=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
          FUNCTIONS=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
          BRANCHES=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
          STATEMENTS=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)

          echo "Coverage Report:"
          echo "Lines: $LINES%"
          echo "Functions: $FUNCTIONS%"
          echo "Branches: $BRANCHES%"
          echo "Statements: $STATEMENTS%"

          # Fail if below threshold
          THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
          FAILED=0
          
          if [ $(echo "$LINES < $THRESHOLD" | awk '{print ($1 < $3)}') -eq 1 ]; then
            echo "‚ùå Lines coverage below ${THRESHOLD}%: $LINES%"
            FAILED=1
          fi
          if [ $(echo "$FUNCTIONS < $THRESHOLD" | awk '{print ($1 < $3)}') -eq 1 ]; then
            echo "‚ùå Functions coverage below ${THRESHOLD}%: $FUNCTIONS%"
            FAILED=1
          fi
          if [ $(echo "$BRANCHES < $THRESHOLD" | awk '{print ($1 < $3)}') -eq 1 ]; then
            echo "‚ùå Branches coverage below ${THRESHOLD}%: $BRANCHES%"
            FAILED=1
          fi
          if [ $(echo "$STATEMENTS < $THRESHOLD" | awk '{print ($1 < $3)}') -eq 1 ]; then
            echo "‚ùå Statements coverage below ${THRESHOLD}%: $STATEMENTS%"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            echo "‚ùå Coverage thresholds not met"
            exit 1
          fi

          echo "‚úÖ Coverage check completed"
        else
          echo "‚ö†Ô∏è No coverage summary found"
          exit 1
        fi
      continue-on-error: false

    - name: Run Performance Gates
      run: npm run test:unit test/performance/critical-paths.test.js
      continue-on-error: false

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      if: ${{ always() }}
      continue-on-error: true
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-${{ github.run_number }}
        path: coverage/
        retention-days: 7
        if-no-files-found: ignore

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: lint-and-format

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      run: |
        # Audit production dependencies only (exclude devDependencies like clinic.js)
        npm audit --omit=dev --audit-level=moderate --json > npm-audit-results.json || true
        if [ -f npm-audit-results.json ]; then
          VULNERABILITIES=$(jq -r '.metadata.vulnerabilities.total // 0' npm-audit-results.json)
          echo "Found $VULNERABILITIES production vulnerabilities"
          
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "‚ö†Ô∏è Production vulnerabilities found:"
            jq '.metadata.vulnerabilities' npm-audit-results.json
          fi
          
          # Only fail if critical/high vulnerabilities in production deps
          CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)
          HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-results.json)
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 5 ]; then
            echo "‚ùå Critical or too many high vulnerabilities in production dependencies"
            exit 1
          fi
          
          echo "‚úÖ Production dependencies security check passed"
        fi

    - name: Run Snyk scan
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results-${{ github.run_number }}
        path: npm-audit-results.json
        retention-days: 7
        if-no-files-found: ignore

  build-and-validate:
    name: Build & Validate
    runs-on: ubuntu-latest
    needs: [lint-and-format, test-coverage]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build CSS
      run: npm run build:css

    - name: Validate build artifacts
      run: |
        echo "üîç Validating build artifacts..."
        if [ ! -f "public/css/tailwind.css" ]; then
          echo "‚ùå CSS build failed - tailwind.css not found"
          exit 1
        fi
        echo "‚úÖ Build artifacts validated"

    - name: Run contract validation
      run: npm run validate:full
      continue-on-error: true

    - name: Check deployment readiness
      run: |
        echo "üöÄ Checking deployment readiness..."
        
        # Check package.json integrity
        npm ls --depth=0 > /dev/null 2>&1 || echo "‚ö†Ô∏è Package dependency warnings"

        # Check for critical files
        CRITICAL_FILES=("package.json" "api/server.js" "api/app.js" "public/index.html")
        for file in "${CRITICAL_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Critical file missing: $file"
            exit 1
          fi
        done

        echo "‚úÖ Deployment readiness checks passed"

    - name: Create deployment artifact
      run: |
        echo "üì¶ Creating deployment artifact..."
        mkdir -p dist
        cp -r api/ dist/
        cp -r public/ dist/
        cp package.json dist/
        cp package-lock.json dist/
        echo "‚úÖ Deployment artifact created"

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifact-${{ github.run_number }}
        path: dist/
        retention-days: 7

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [build-and-validate]
    timeout-minutes: 30
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Build CSS
      run: npm run build:css

    - name: Create .env file
      run: |
        echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
        echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> .env
        echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
        echo "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" >> .env
        echo "NODE_ENV=test" >> .env
        echo "PORT=3000" >> .env
        echo "BASE_URL=http://localhost:3000" >> .env

    - name: Verify environment variables
      run: |
        echo "üîç Verifying environment variables..."
        if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
          echo "‚ùå SUPABASE_URL secret is missing"
          exit 1
        fi
        if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
          echo "‚ùå SUPABASE_SERVICE_ROLE_KEY secret is missing"
          exit 1
        fi
        if [ -z "${{ secrets.JWT_SECRET }}" ]; then
          echo "‚ùå JWT_SECRET secret is missing"
          exit 1
        fi
        if [ -z "${{ secrets.SESSION_SECRET }}" ]; then
          echo "‚ùå SESSION_SECRET secret is missing"
          exit 1
        fi
        echo "‚úÖ All required secrets are available"

    - name: Seed test data
      run: |
        echo "üå± Starting seeding process..."
        # Give database more time to initialize
        sleep 10
        # Run seeding
        node seed-test-data.js || echo "‚ö†Ô∏è Seeding failed, but continuing with tests..."
      env:
        NODE_ENV: test
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
      continue-on-error: true

    - name: Start App with Enhanced Logging and Robust Wait Loop
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
        NODE_ENV: test
        PORT: 3000
        START_SERVER_IN_TEST: true
        # Disable problematic security features in test
        CSP_ENABLED: false
        RATE_LIMIT_MAX: 5000
        NODE_OPTIONS: "--max-old-space-size=4096"
        # Enhanced database connection settings
        DB_CONNECTION_TIMEOUT: 30000
        DB_MAX_CONNECTIONS: 20
        DB_CONNECTION_RETRIES: 10
      run: |
        echo "üöÄ Starting app on port 3000..."
        echo "Environment: $NODE_ENV"
        echo "Port: $PORT"
        echo "START_SERVER_IN_TEST: $START_SERVER_IN_TEST"
        
        # Start server with enhanced logging
        npm start > server.log 2>&1 &
        SERVER_PID=$!
        
        echo "Server PID: $SERVER_PID"
        echo "Waiting for app service..."
        
        # Wait for server with enhanced error handling and robust loop
        MAX_ATTEMPTS=45  # Further increased attempts for better reliability
        WAIT_TIME=2   # Reduced wait time for faster feedback
        READY=false
        
        for i in $(seq 1 $MAX_ATTEMPTS); do
          echo "Attempt $i/$MAX_ATTEMPTS: Checking server status..."
          
          # Check if server process is still running
          if ! kill -0 $SERVER_PID 2>/dev/null; then
            echo "‚ùå Server process died unexpectedly"
            echo "Server logs:"
            cat server.log
            echo "Process status:"
            ps aux | grep node || echo "No node processes found"
            exit 1
          fi
          
          # Try to connect to server with timeout - increased to 10 seconds
          if timeout 10 curl -f http://localhost:3000/health >/dev/null 2>&1; then
            echo "‚úÖ App service is ready after $((i*WAIT_TIME)) seconds!"
            READY=true
            break
          fi
          
          # Show recent logs for debugging at more frequent intervals
          if [ $i -eq 5 ] || [ $i -eq 10 ] || [ $i -eq 15 ] || [ $i -eq 20 ] || [ $i -eq 25 ] || [ $i -eq 30 ] || [ $i -eq 35 ] || [ $i -eq 40 ]; then
            echo "--- Recent server logs (attempt $i) ---"
            tail -30 server.log
            echo "--- End of logs ---"
          fi
          
          sleep $WAIT_TIME
        done
        
        if [ "$READY" = false ]; then
          echo "‚ùå App service failed to start within $((MAX_ATTEMPTS*WAIT_TIME)) seconds"
          echo "Full server logs:"
          cat server.log
          echo "Process status:"
          ps aux | grep node || echo "No node processes found"
          echo "Network connections:"
          netstat -tlnp 2>/dev/null | grep :3000 || echo "No process listening on port 3000"
          exit 1
        fi

    - name: Run Playwright tests
      run: npm run test:e2e
      env:
        CI: true
        NODE_ENV: test
        BASE_URL: http://localhost:3000

    - name: Upload server logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: server-logs-${{ github.run_number }}
        path: server.log
        retention-days: 7
        if-no-files-found: ignore

    - name: Upload Playwright report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ github.run_number }}
        path: playwright-report/
        retention-days: 7
        if-no-files-found: ignore

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: [build-and-validate]
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Vercel Preview
      run: |
        echo "üìù Preview deployment would go here"
        echo "PR: ${{ github.event.pull_request.number }}"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-validate, e2e-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build CSS
      run: npm run build:css

    - name: Deploy to Production
      run: |
        echo "üöÄ Production deployment would go here"
        echo "Branch: ${{ github.ref }}"

    - name: Create deployment tag
      run: |
        TAG_NAME="deploy-$(date +%Y%m%d-%H%M%S)"
        echo "Created tag: $TAG_NAME"