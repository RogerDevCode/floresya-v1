<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Users Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
      <h1 class="text-3xl font-bold mb-6">Test Users Page</h1>

      <div id="test-results" class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">Test Results</h2>
        <div id="results" class="space-y-2"></div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">Manual Test</h2>
        <p>
          Navigate to:
          <a
            href="http://localhost:3000/admin/dashboard.html"
            target="_blank"
            class="text-blue-600 underline"
            >Admin Dashboard</a
          >
        </p>
        <p>Click on "Usuarios" in the sidebar</p>
      </div>
    </div>

    <script>
      const tests = []

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString()
        const colors = {
          info: 'text-blue-600',
          success: 'text-green-600',
          error: 'text-red-600',
          warning: 'text-yellow-600'
        }

        const result = document.createElement('div')
        result.className = `${colors[type]} text-sm`
        result.innerHTML = `[${timestamp}] ${message}`

        document.getElementById('results').appendChild(result)
        console.log(`[${type.toUpperCase()}] ${message}`)

        tests.push({ message, type, timestamp })
      }

      async function runTests() {
        log('ðŸ” Starting Users Page Tests...', 'info')

        try {
          // Test 1: Check if server is running
          log('1. Testing server connectivity...', 'info')
          const response = await fetch('http://localhost:3000/api/users')
          if (response.ok) {
            log('âœ… Server is responding', 'success')

            // Test 2: Check users API
            log('2. Testing users API...', 'info')
            const data = await response.json()
            log(`ðŸ“Š API Response: ${JSON.stringify(data).substring(0, 200)}...`, 'info')

            if (data.success && data.data) {
              log(`âœ… Found ${data.data.length} users in API`, 'success')

              // Test 3: Check user data structure
              log('3. Checking user data structure...', 'info')
              if (data.data.length > 0) {
                const firstUser = data.data[0]
                const requiredFields = ['id', 'email', 'role', 'is_active', 'email_verified']
                const hasRequiredFields = requiredFields.every(field =>
                  firstUser.hasOwnProperty(field)
                )

                if (hasRequiredFields) {
                  log('âœ… User data structure is correct', 'success')
                  log(`ðŸ“ First user: ${firstUser.email} (${firstUser.role})`, 'info')
                } else {
                  log('âŒ User data structure is missing required fields', 'error')
                  log(
                    `Missing: ${requiredFields.filter(f => !firstUser.hasOwnProperty(f)).join(', ')}`,
                    'error'
                  )
                }
              }

              // Test 4: Check email verification filtering
              log('4. Testing email verification filter...', 'info')
              const verifiedResponse = await fetch(
                'http://localhost:3000/api/users?email_verified=true'
              )
              const verifiedData = await verifiedResponse.json()

              if (verifiedData.success) {
                log(
                  `âœ… Email verification filter works: ${verifiedData.data.length} verified users`,
                  'success'
                )
              } else {
                log('âŒ Email verification filter failed', 'error')
              }

              // Test 5: Check role filtering
              log('5. Testing role filter...', 'info')
              const adminResponse = await fetch('http://localhost:3000/api/users?role=admin')
              const adminData = await adminResponse.json()

              if (adminData.success) {
                log(`âœ… Role filter works: ${adminData.data.length} admin users`, 'success')

                // Check if admin user (ID 1) is protected
                const adminUser = adminData.data.find(u => u.id === 1)
                if (adminUser) {
                  log(`âœ… Admin user ID 1 found: ${adminUser.email}`, 'success')
                } else {
                  log('âš ï¸ Admin user ID 1 not found', 'warning')
                }
              } else {
                log('âŒ Role filter failed', 'error')
              }

              // Test 6: Check search functionality
              log('6. Testing search functionality...', 'info')
              const searchResponse = await fetch('http://localhost:3000/api/users?search=test')
              const searchData = await searchResponse.json()

              if (searchData.success) {
                log(`âœ… Search works: ${searchData.data.length} results for "test"`, 'success')
              } else {
                log('âŒ Search functionality failed', 'error')
              }
            } else {
              log('âŒ API response is not successful', 'error')
            }
          } else {
            log(`âŒ Server responded with status: ${response.status}`, 'error')
          }

          // Test 7: Check frontend files exist
          log('7. Checking frontend files...', 'info')
          try {
            const dashboardResponse = await fetch('http://localhost:3000/admin/dashboard.html')
            if (dashboardResponse.ok) {
              log('âœ… Dashboard HTML is accessible', 'success')
            } else {
              log('âŒ Dashboard HTML not accessible', 'error')
            }
          } catch (error) {
            log(`âŒ Error accessing dashboard: ${error.message}`, 'error')
          }

          log('ðŸŽ‰ Tests completed!', 'success')
        } catch (error) {
          log(`âŒ Test failed with error: ${error.message}`, 'error')
          console.error(error)
        }
      }

      // Run tests when page loads
      window.addEventListener('load', runTests)

      // Also provide a button to re-run tests
      document.addEventListener('DOMContentLoaded', () => {
        const button = document.createElement('button')
        button.className = 'mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
        button.textContent = 'Re-run Tests'
        button.onclick = () => {
          document.getElementById('results').innerHTML = ''
          runTests()
        }
        document.querySelector('.bg-white').appendChild(button)
      })
    </script>
  </body>
</html>
