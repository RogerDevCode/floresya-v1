/**
 * Product Controller Tests - Advanced Mocking Strategy
 * Soluciona problemas de ES6 modules y mocking complejo
 */

import { describe, test, expect, beforeEach, vi } from 'vitest'

// Mock de servicios a nivel de módulo - ANTES de importar el controller
vi.mock('../../../../api/services/productService.js', () => {
  // Create mutable mock functions that can be changed during tests
  const mockFunctions = {
    getAllProducts: vi.fn(),
    getProductById: vi.fn(),
    getProductBySku: vi.fn(),
    createProduct: vi.fn(),
    updateProduct: vi.fn(),
    updateStock: vi.fn(),
    deleteProduct: vi.fn(),
    reactivateProduct: vi.fn(),
    getProductsWithOccasions: vi.fn(),
    getProductsByOccasion: vi.fn(),
    getProductOccasions: vi.fn(),
    linkProductOccasion: vi.fn(),
    replaceProductOccasions: vi.fn(),
    createProductWithOccasions: vi.fn(),
    getCarouselProducts: vi.fn(), // getCarouselProducts está en productService
    updateCarouselOrder: vi.fn()
  }

  return mockFunctions
})

// Mock de carousel service - para updateCarouselOrder que está en carouselService
vi.mock('../../../../api/services/carouselService.js', () => ({
  getCarouselProducts: vi.fn(), // No se usa en controller pero mantenemos por consistencia
  updateCarouselOrder: vi.fn(),
  resolveCarouselOrderConflict: vi.fn()
}))

// Mock de errorHandler - debe estar antes de importar controllers
vi.mock('../../../../api/middleware/errorHandler.js', () => ({
  asyncHandler: vi.fn(fn => fn),
  errorHandler: vi.fn(),
  notFoundHandler: vi.fn()
}))

// Mock de clases de error
vi.mock('../../../../api/errors/AppError.js', () => ({
  ValidationError: class ValidationError extends Error {
    constructor(message, details) {
      super(message)
      this.name = 'ValidationError'
      this.details = details
    }
  },
  NotFoundError: class NotFoundError extends Error {
    constructor(entity, id) {
      super(`${entity} with ID ${id} not found`)
      this.name = 'NotFoundError'
    }
  },
  BadRequestError: class BadRequestError extends Error {
    constructor(message, details) {
      super(message)
      this.name = 'BadRequestError'
      this.details = details
    }
  }
}))

describe('Product Controller - Advanced Mocking', () => {
  let productController
  let mockReq, mockRes

  beforeEach(async () => {
    vi.clearAllMocks()

    // Import controller después de configurar mocks
    const controllerModule = await import('../../../../api/controllers/productController.js')
    productController = controllerModule

    // Setup mock request/response
    mockReq = {
      query: { limit: '10', offset: '0' },
      params: { id: '1' },
      body: { name: 'Test Product', price_usd: 29.99 },
      user: { role: 'admin' }
    }

    mockRes = {
      status: vi.fn().mockReturnThis(),
      json: vi.fn().mockReturnThis()
    }
  })

  describe('getAllProducts', () => {
    test('should return products successfully', async () => {
      // Arrange - Configurar el mock para este test específico
      const { getAllProducts } = await import('../../../../api/services/productService.js')
      const mockProducts = [
        { id: 1, name: 'Test Product 1', active: true },
        { id: 2, name: 'Test Product 2', active: true }
      ]
      getAllProducts.mockResolvedValue(mockProducts)

      // Act
      await productController.getAllProducts(mockReq, mockRes)

      // Assert
      expect(mockRes.json).toHaveBeenCalled()
      expect(getAllProducts).toHaveBeenCalled()
    })

    test('should handle empty products array', async () => {
      // Arrange
      const { getAllProducts } = await import('../../../../api/services/productService.js')
      getAllProducts.mockResolvedValue([])

      // Act
      await productController.getAllProducts(mockReq, mockRes)

      // Assert
      expect(mockRes.json).toHaveBeenCalled()
    })

    test('should handle database errors', async () => {
      // Arrange
      const { getAllProducts } = await import('../../../../api/services/productService.js')
      getAllProducts.mockRejectedValue(new Error('Database connection failed'))

      // Act & Assert
      await expect(productController.getAllProducts(mockReq, mockRes)).rejects.toThrow(
        'Database connection failed'
      )
    })
  })

  describe('getProductById', () => {
    test('should return product by ID successfully', async () => {
      // Arrange
      const { getProductById } = await import('../../../../api/services/productService.js')
      const mockProduct = { id: 1, name: 'Test Product', active: true }
      getProductById.mockResolvedValue(mockProduct)

      // Act
      await productController.getProductById(mockReq, mockRes)

      // Assert
      expect(mockRes.json).toHaveBeenCalled()
      expect(getProductById).toHaveBeenCalled()
    })

    test('should handle non-existent product', async () => {
      // Arrange
      const { getProductById } = await import('../../../../api/services/productService.js')
      const { NotFoundError } = await import('../../../../api/errors/AppError.js')
      getProductById.mockRejectedValue(new NotFoundError('Product', 1))

      // Act & Assert
      await expect(productController.getProductById(mockReq, mockRes)).rejects.toThrow(
        'Product with ID 1 not found'
      )
    })
  })

  describe('createProduct', () => {
    test('should create product successfully', async () => {
      // Arrange
      const { createProduct } = await import('../../../../api/services/productService.js')
      const mockProduct = { id: 1, name: 'Test Product', price_usd: 29.99, active: true }
      createProduct.mockResolvedValue(mockProduct)

      mockReq.body = { name: 'Test Product', price_usd: 29.99, stock: 10 }

      // Act
      await productController.createProduct(mockReq, mockRes)

      // Assert
      expect(mockRes.status).toHaveBeenCalled()
      expect(mockRes.json).toHaveBeenCalled()
      expect(createProduct).toHaveBeenCalled()
    })

    test('should handle validation errors', async () => {
      // Arrange
      const { createProduct } = await import('../../../../api/services/productService.js')
      const { ValidationError } = await import('../../../../api/errors/AppError.js')
      createProduct.mockRejectedValue(new ValidationError('Product validation failed'))

      mockReq.body = { price_usd: 29.99 } // Missing name

      // Act & Assert
      await expect(productController.createProduct(mockReq, mockRes)).rejects.toThrow(
        'Product validation failed'
      )
    })
  })

  describe('updateProduct', () => {
    test('should update product successfully', async () => {
      // Arrange
      const { updateProduct } = await import('../../../../api/services/productService.js')
      const mockProduct = { id: 1, name: 'Updated Product', active: true }
      updateProduct.mockResolvedValue(mockProduct)

      mockReq.body = { name: 'Updated Product' }

      // Act
      await productController.updateProduct(mockReq, mockRes)

      // Assert
      expect(mockRes.json).toHaveBeenCalled()
      expect(updateProduct).toHaveBeenCalled()
    })
  })

  describe('deleteProduct', () => {
    test('should delete product successfully', async () => {
      // Arrange
      const { deleteProduct } = await import('../../../../api/services/productService.js')
      deleteProduct.mockResolvedValue(true)

      // Act
      await productController.deleteProduct(mockReq, mockRes)

      // Assert
      expect(mockRes.json).toHaveBeenCalled()
      expect(deleteProduct).toHaveBeenCalled()
    })
  })

  describe('getCarouselProducts', () => {
    test('should return carousel products successfully', async () => {
      // Arrange
      const { getCarouselProducts } = await import('../../../../api/services/productService.js')
      const mockCarouselProducts = [
        { id: 1, name: 'Carousel Product 1', active: true },
        { id: 2, name: 'Carousel Product 2', active: true }
      ]
      getCarouselProducts.mockResolvedValue(mockCarouselProducts)

      // Act
      await productController.getCarouselProducts(mockReq, mockRes)

      // Assert
      expect(mockRes.json).toHaveBeenCalled()
      expect(getCarouselProducts).toHaveBeenCalled()
    })
  })

  describe('Function Exports Validation', () => {
    test('should export all required controller functions', () => {
      // Assert - Verificar que todas las funciones esperadas estén disponibles
      const requiredFunctions = [
        'getAllProducts',
        'getProductById',
        'getProductBySku',
        'getCarouselProducts',
        'getProductsWithOccasions',
        'getProductsByOccasion',
        'createProduct',
        'createProductWithOccasions',
        'updateProduct',
        'updateCarouselOrder',
        'updateStock',
        'deleteProduct',
        'reactivateProduct',
        'getProductOccasions',
        'linkProductOccasion',
        'replaceProductOccasions'
      ]

      requiredFunctions.forEach(funcName => {
        expect(productController[funcName]).toBeDefined()
        expect(typeof productController[funcName]).toBe('function')
      })
    })

    test('should have proper function signatures', () => {
      // Assert - Verificar que las funciones tengan las firmas correctas
      expect(productController.getAllProducts.length).toBeGreaterThanOrEqual(2) // req, res
      expect(productController.getProductById.length).toBeGreaterThanOrEqual(2)
      expect(productController.createProduct.length).toBeGreaterThanOrEqual(2)
      expect(productController.updateProduct.length).toBeGreaterThanOrEqual(2)
      expect(productController.deleteProduct.length).toBeGreaterThanOrEqual(2)
    })
  })
})
